<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Mr. White's Help Page v1.0</title>
  <style>
    h1 {
      text-align: center;
      font-family: Arial, Helvetica, sans-serif
    }

    button.room-button {
      padding: 12px;
      margin: 8px;
    }

    button.room-selected {
      background-color: darkgray;
      color: white;
    }

    form {
      border: 1px solid black;
      margin: 16px;
      border-radius: 16px;
    }

    form * {
      padding: 8px;
    }

    form .title {
      font-family: Arial, Helvetica, sans-serif;
      text-align: center;
      border-bottom: 1px solid gray;
      background-color: lightblue;
      border-radius: 16px 16px 0 0;
    }

    form .input {
      float: left;
    }

    form .input-your-name {
      width: 20%;
    }

    form .input-your-problem {
      width: 80%;
    }

    .unresolved-ticket {
      background-color: lightgray;
      padding: 8px;
      margin: 16px;
      text-align: center;
      font-family: Arial, Helvetica, sans-serif;
      border: 1px solid black;
      border-radius: 16px;
    }
  </style>
</head>
<body>
  <h1>Mr. White's Help Page</h1>
  <!-- Empty Div to Put Class Buttons -->
  <div class="room-select"></div>

  <!-- Help Request Submission Form -->
  <form id="help-form" action="javascript:addTicket()" >
    <div class="title">Request Help</div>
    <div class="input input-your-name">
      <label for="your-name">Your Name:</label>
      <input type="text" class="your-name" name="Name">
    </div>
    <div class="input input-your-problem">
      <label for="your-problem">Brief Description of Your Problem:</label>
      <input type="text" class="your-problem" name="Problem Description" style="min-width: 400px;">
      <button type="submit">Help!</button>
    </div>
    <div style="clear: both;"></div>
  </form>

  <!-- Empty Div to Put Tickets from DB -->
  <div id="waiting-tickets"></div>

  <!-- Import Firebase -->
  <script src="https://www.gstatic.com/firebasejs/4.6.0/firebase.js"></script>
  <script>
    'use strict';

    function selectClassroom() {
      const rooms = [
        { display: 'Mr. Castro', code: 'CASTRO' },
      ];
      const roomMarkup = rooms.reduce((mk, room) => `${mk}<button class="room-button" data-code="${room.code}">${room.display}</button>`, '');

      document.getElementsByClassName('room-select')[0].innerHTML = `<hr>${roomMarkup}<hr>`;

      const allButtons = document.querySelectorAll('button.room-button');
      if (rooms.length === 1) {
        allButtons[0].classList.add('room-selected');
        classroomRef = rooms[0].code;
      } else {
        [...document.querySelectorAll('button.room-button')].forEach(btn => {
          btn.addEventListener('click', (evt) => {
            allButtons.forEach(btn => btn.classList.remove('room-selected'));
            evt.currentTarget.classList.add('room-selected');
            classroomRef = evt.currentTarget.getAttribute('data-code');
            displayUnresolvedTickets(tixRef);
          });
        });
      }
    }

    /**
     * Gathers User info from form, of which there is only one on the page, and submits it to the Firebase DB.
     */
    function addTicket() {
      const form = document.getElementById('help-form');
      const inputs = form.getElementsByTagName('input');
      const ticketData = {
        name: form.getElementsByClassName('your-name')[0].value,
        problem: form.getElementsByClassName('your-problem')[0].value,
        submitTime: Date.now(),
        resolved: false,
        room: classroomRef,
      };

      // Name and Problem Description are required.
      if (ticketData.name && ticketData.problem) {
        // Push to Firebase DB
        tickets.push(ticketData);
        // Clear out the inputs on successful submit
        [...inputs].forEach(input => ['value', 'placeholder'].forEach(prop => input[prop] = ''));
      } else {
        // Put a warning as placeholder in the inputs
        [...inputs].forEach(input => {
          input.placeholder = `⚠️ ${input.getAttribute('name')} field required`;
        });
      }
    }

    /**
     * Removes the ticket from the active queue.  Click handler for clicking a "Problem Solved" button.
     * @param {Event} evt The click event on the "Problem Solved" button.
     */
    function removeFromActive(evt) {
      tickets.database.ref(`/tickets/${evt.currentTarget.getAttribute('data-id')}`).remove();
    }

    /**
     * Sets a ticket's resolved value to "true", and pushes it to the fixed tickets list in Firebase DB.
     * Callback for on.child_removed.
     * @param {Firebase} resolved The Firebase dataset from the change handler.
     */
    function resolveTicket(resolved) {
      const resolvedTicket = resolved.exportVal();

      resolvedTicket.resolved = true;
      fixedTickets.push(resolvedTicket);
    }

    /**
     * Builds a markup display for each ticket in the dataset from Firebase DB.
     * Callback for on.value.
     * @param {Firebase} tix Firebase list of tickets in the "tickets" path.
     */
    function displayUnresolvedTickets(tix) {
      let markup = '';

      // Update the page's knowledge of all the tickets, even the ones not for our class.
      tixRef = tix;

      // Iterate through the list and increase the markup.
      tix.forEach(function(ticket) {
        const val = ticket.exportVal();
        markup += val && !val.resolved && val.room === classroomRef ? `
          <div class="unresolved-ticket" data-ticket-id="${val.submitTime}">
            <p>Help Requested</p>
            <p>${val.name} needs help: ${val.problem}</p>
            <button class="fixed" data-id="${ticket.key}">Problem Solved</button>
          </div>
        ` : '';
      });

      // Grab the empty div once and put all the generated markup in there.
      document.getElementById('waiting-tickets').innerHTML = markup;
      // Add click handlers on all the ticket buttons.
      [...document.getElementsByClassName('fixed')].forEach(btn => btn.addEventListener('click', removeFromActive));
    }

    // Initialize Firebase
    var config = {
      apiKey: "AIzaSyDra7orv66iLs8GRMGTkqjWn99oe7jlU50",
      authDomain: "mrwshelppage.firebaseapp.com",
      databaseURL: "https://mrwshelppage.firebaseio.com",
      projectId: "mrwshelppage",
      storageBucket: "mrwshelppage.appspot.com",
      messagingSenderId: "875158055700"
    };
    firebase.initializeApp(config);

    // Set page ref for which classroom we're in.
    var classroomRef = '';

    // Set refs for the two Firebase DB lists.
    var tickets = firebase.database().ref('/tickets/');
    var fixedTickets = firebase.database().ref('/resolved/');

    // Set a global Ref for the tickets.
    // TODO: Make this not in global scope once scripts are moved out.
    var tixRef;

    // Run the function that adds the classroom selection buttons to the page.
    selectClassroom();

    // Set listeners on the two events we're working with: value and child_removed.
    tickets.on('value', displayUnresolvedTickets);
    tickets.on('child_removed', resolveTicket);

  </script>
</body>
</html>
